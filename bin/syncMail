#!/usr/bin/python
from subprocess import Popen, PIPE

p = Popen(["ssh", "syncmail@glacicle.org"], stdout=PIPE)
fd = None
folder = None

while True:
    line = p.stdout.readline().replace("\r\n", "\n")
    if line:
        if line.startswith("--new : "):
            folder = line[8:-6]
            fname = Popen(["mhpath", "+"+folder, "new"], stdout=PIPE)\
                        .stdout.readline().strip("\r\n")
            fnum = fname.split("/")[-1]
            fd = None
            fd = open(fname, "w")
        elif line.startswith("--end--"):
            # Close the file
            fd.close()

            # Mark as unread
            Popen(["mark", "+"+folder, "-seq", "unseen", fnum])

            # Rethread
            Popen(["/home/archlucas/bin/mhthread.pl", "+"+folder])

            # Notify
            if folder == "inbox":
                new = Popen(["scan", "+inbox", "unseen"], stdout=PIPE)
                amount = 0

                while True:
                    line = new.stdout.readline()

                    if line:
                        amount += 1
                    else:
                        break

                with open("/tmp/awesome-remote", "a") as notif:
                    notif.write("mailnotify_set(%d)\n" % amount)
        elif fd is not None:
            fd.write(line)
